// Add this JavaScript to your frontend/index.html <script> section
// Replace the existing API calling functions with these improved versions

// Better error handling for API calls
async function safeApiCall(url, options = {}) {
    try {
        console.log(`üîó Making API call to: ${url}`);
        
        const response = await fetch(url, {
            ...options,
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                ...options.headers
            }
        });
        
        console.log(`üìä Response status: ${response.status}`);
        console.log(`üìã Response headers:`, response.headers.get('content-type'));
        
        // Check if response is OK
        if (!response.ok) {
            const errorText = await response.text();
            console.error(`‚ùå API Error (${response.status}):`, errorText);
            
            // Try to parse as JSON first, fall back to text
            let errorData;
            try {
                errorData = JSON.parse(errorText);
            } catch {
                errorData = { error: errorText, status: response.status };
            }
            
            throw new Error(`HTTP ${response.status}: ${errorData.error || errorText}`);
        }
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const responseText = await response.text();
            console.error('‚ùå Non-JSON response received:', responseText.substring(0, 200) + '...');
            
            // If it's HTML, it might be an error page
            if (responseText.includes('<!DOCTYPE') || responseText.includes('<html>')) {
                throw new Error('Server returned HTML instead of JSON - check server logs for errors');
            }
            
            throw new Error('Server returned non-JSON response');
        }
        
        const data = await response.json();
        console.log('‚úÖ API Response successful:', Object.keys(data));
        return data;
        
    } catch (error) {
        console.error('‚ùå API call failed:', error);
        showError(`API Error: ${error.message}`);
        throw error;
    }
}

// Replace your existing loadApplications function
async function loadApplications() {
    try {
        console.log('üìã Loading applications...');
        const applications = await safeApiCall('/api/applications');
        displayApplications(applications);
        console.log(`‚úÖ Loaded ${applications.length} applications`);
    } catch (error) {
        console.error('Failed to load applications:', error);
        displayApplications([]); // Show empty state
        showError('Failed to load applications. The server may be starting up.');
    }
}

// Replace your existing loadStats function
async function loadStats() {
    try {
        console.log('üìä Loading statistics...');
        const stats = await safeApiCall('/api/stats');
        
        if (stats && stats.totals) {
            document.getElementById('totalApplications').textContent = stats.totals.total_applications || 0;
            document.getElementById('slotsFound').textContent = stats.totals.total_slots_found || 0;
            document.getElementById('completedApplications').textContent = stats.totals.completed_applications || 0;
            document.getElementById('activeApplications').textContent = stats.totals.active_applications || 0;
            console.log('‚úÖ Statistics updated');
        } else {
            console.warn('‚ö†Ô∏è No stats data received');
        }
    } catch (error) {
        console.error('Failed to load stats:', error);
        // Set default values on error
        document.getElementById('totalApplications').textContent = '0';
        document.getElementById('slotsFound').textContent = '0';
        document.getElementById('completedApplications').textContent = '0';
        document.getElementById('activeApplications').textContent = '0';
    }
}

// Replace your existing toggleMonitoring function
async function toggleMonitoring() {
    const button = document.getElementById('toggleMonitoringBtn');
    const buttonText = document.getElementById('toggleText');
    
    button.disabled = true;
    
    try {
        console.log(`üîÑ Toggling monitoring...`);
        
        if (isMonitoring) {
            console.log('üõë Stopping monitoring...');
            const result = await safeApiCall('/api/monitoring/stop', { method: 'POST' });
            
            if (result.success) {
                isMonitoring = false;
                buttonText.textContent = 'Start Monitoring';
                button.className = button.className.replace('bg-red-600 hover:bg-red-700', 'bg-green-600 hover:bg-green-700');
                updateSystemStatus(false);
                showSuccess(result.message || 'Monitoring stopped');
                console.log('‚úÖ Monitoring stopped successfully');
            } else {
                showError(result.error || 'Failed to stop monitoring');
            }
        } else {
            console.log('üöÄ Starting monitoring...');
            const result = await safeApiCall('/api/monitoring/start', { method: 'POST' });
            
            if (result.success) {
                isMonitoring = true;
                buttonText.textContent = 'Stop Monitoring';
                button.className = button.className.replace('bg-green-600 hover:bg-green-700', 'bg-red-600 hover:bg-red-700');
                updateSystemStatus(true);
                showSuccess(result.message || 'Monitoring started');
                console.log('‚úÖ Monitoring started successfully');
                
                // Show additional info if available
                if (result.platform) {
                    console.log(`üåê Platform: ${result.platform}`);
                }
                if (result.mode) {
                    console.log(`ü§ñ Mode: ${result.mode}`);
                }
            } else {
                showError(result.error || 'Failed to start monitoring');
                console.error('‚ùå Monitoring start failed:', result);
            }
        }
    } catch (error) {
        console.error('‚ùå Toggle monitoring failed:', error);
        showError(`Operation failed: ${error.message}`);
    } finally {
        button.disabled = false;
    }
}

// Replace your existing form submission handler
function setupFormSubmission() {
    document.getElementById('applicationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        console.log('üìù Submitting application form...');

        const formData = {
            country: document.getElementById('country').value,
            visa_type: document.getElementById('visaType').value,
            first_name: document.getElementById('firstName').value,
            last_name: document.getElementById('lastName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            passport_number: document.getElementById('passportNumber').value,
            date_of_birth: document.getElementById('dateOfBirth').value,
            nationality: document.getElementById('nationality').value,
            address: document.getElementById('address').value,
            preferred_center: document.getElementById('preferredCenter').value,
            site_email: document.getElementById('siteEmail').value,
            site_password: document.getElementById('sitePassword').value,
            priority: parseInt(document.getElementById('priority').value),
            auto_book: document.getElementById('autoBook').checked
        };

        try {
            console.log('üöÄ Creating application...', formData.first_name, formData.last_name);
            
            const result = await safeApiCall('/api/applications', {
                method: 'POST',
                body: JSON.stringify(formData)
            });
            
            if (result.success) {
                showSuccess(result.message || 'Application created successfully!');
                document.getElementById('applicationForm').reset();
                showTab('applications');
                loadApplications();
                loadStats();
                console.log('‚úÖ Application created successfully');
            } else {
                showError(result.error || 'Failed to create application');
            }
        } catch (error) {
            console.error('‚ùå Form submission failed:', error);
            showError(`Failed to create application: ${error.message}`);
        }
    });
}

// Replace your deleteApplication function
async function deleteApplication(id) {
    if (!confirm('Are you sure you want to delete this application?')) {
        return;
    }

    try {
        console.log(`üóëÔ∏è Deleting application ${id}...`);
        
        const result = await safeApiCall(`/api/applications/${id}`, {
            method: 'DELETE'
        });
        
        if (result.success) {
            showSuccess(result.message || 'Application deleted successfully');
            loadApplications();
            loadStats();
            console.log('‚úÖ Application deleted successfully');
        } else {
            showError(result.error || 'Failed to delete application');
        }
    } catch (error) {
        console.error('‚ùå Delete failed:', error);
        showError(`Failed to delete application: ${error.message}`);
    }
}

// Replace your loadMonitoringStatus function
async function loadMonitoringStatus() {
    try {
        console.log('üìä Loading monitoring status...');
        const status = await safeApiCall('/api/monitoring/status');
        
        isMonitoring = status.isRunning || false;
        
        document.getElementById('monitoringSystemStatus').textContent = status.isRunning ? 'Running' : 'Stopped';
        document.getElementById('activeCountries').textContent = status.activeCountries && status.activeCountries.length > 0 ? status.activeCountries.join(', ') : 'None';
        document.getElementById('startTime').textContent = status.startTime ? new Date(status.startTime).toLocaleString() : '-';
        document.getElementById('lastActivity').textContent = status.lastActivity ? new Date(status.lastActivity).toLocaleString() : '-';
        
        if (status.stats && status.stats.total) {
            document.getElementById('totalSlotsFoundStats').textContent = status.stats.total.slotsFound || 0;
            document.getElementById('totalBookings').textContent = status.stats.total.bookings || 0;
        }
        
        // Update platform info if available
        if (status.platform) {
            console.log(`üåê Platform: ${status.platform}`);
        }
        if (status.browserAutomation) {
            console.log(`ü§ñ Browser: ${status.browserAutomation}`);
        }
        
        // Update button state
        const button = document.getElementById('toggleMonitoringBtn');
        const buttonText = document.getElementById('toggleText');
        
        if (status.isRunning) {
            buttonText.textContent = 'Stop Monitoring';
            button.className = button.className.replace('bg-green-600 hover:bg-green-700', 'bg-red-600 hover:bg-red-700');
            updateSystemStatus(true);
        } else {
            buttonText.textContent = 'Start Monitoring';
            button.className = button.className.replace('bg-red-600 hover:bg-red-700', 'bg-green-600 hover:bg-green-700');
            updateSystemStatus(false);
        }
        
        console.log('‚úÖ Monitoring status updated');
        
    } catch (error) {
        console.error('Failed to load monitoring status:', error);
        // Set safe defaults
        isMonitoring = false;
        updateSystemStatus(false);
    }
}

// Replace your loadLogs function
async function loadLogs() {
    try {
        console.log('üìã Loading activity logs...');
        const logs = await safeApiCall('/api/logs?limit=100');
        displayLogs(logs);
        console.log(`‚úÖ Loaded ${logs.length} log entries`);
    } catch (error) {
        console.error('Failed to load logs:', error);
        displayLogs([]); // Show empty state
        showError('Failed to load activity logs');
    }
}

// Improved error display function
function showError(message) {
    console.error('üö® Error:', message);
    
    // Remove existing error notifications
    const existingErrors = document.querySelectorAll('.error-notification');
    existingErrors.forEach(el => el.remove());
    
    // Create error notification
    const notification = document.createElement('div');
    notification.className = 'error-notification fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 bg-red-100 text-red-800 border border-red-200 max-w-md';
    notification.innerHTML = `
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <div class="ml-3 flex-1">
                <h3 class="text-sm font-medium">Error</h3>
                <p class="text-sm mt-1">${message}</p>
            </div>
            <div class="ml-4 flex-shrink-0">
                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="inline-flex text-red-400 hover:text-red-600">
                    <span class="sr-only">Close</span>
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 10 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 10000);
}

// Test API connectivity on page load
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ Page loaded - testing API connectivity...');
    
    try {
        // Test basic API connectivity
        const health = await safeApiCall('/health');
        console.log('‚úÖ API connectivity test passed:', health);
        
        // Load initial data
        loadApplications();
        loadStats();
        setupFormSubmission();
        startAutoRefresh();
        
    } catch (error) {
        console.error('‚ùå API connectivity test failed:', error);
        showError('Cannot connect to server. Please check your internet connection and refresh the page.');
    }
});